import React, { useEffect, useState, useContext } from "react";
import { StoreContext } from "../hooks/context";
import {ACTION_TYPES} from "../hooks/storeReducer";

import Head from "next/head";
import styles from "../styles/Home.module.css";
import Banner from "../components/banner";
import CoffeeCards from "../components/coffeecards";

import { fetchCoffeeStores } from "../lib/coffee_store";

import trackGeoLocation from "../hooks/trackGeoLocation";

export async function getStaticProps(context) {
  let origin = Intl.DateTimeFormat().resolvedOptions().timeZone;
  origin = origin.split("/")[0];

  const storeData = await fetchCoffeeStores("", origin);
  return {
    props: {
      Stores: storeData,
      origin: origin
    },
  };
}

export default function Home(props) {
  const { trackLocation, locationErrorMsg, findingLocation } = trackGeoLocation();
  
  const { Stores, origin } = props;                         // Stores which we are pre-rendering
  const {state:{latLong, coffeeStores}, dispatch} = useContext(StoreContext);  // Storing stores by user geo location
  

  useEffect(async () => {
    if (latLong) {
      // const storesByLocation = await fetchCoffeeStores(latLong);
      const response = await fetch(`/api/getStoreByLocation?latLong=${latLong}`);
      const storesByLocation = await response.json();
      
      dispatch({type:ACTION_TYPES.FETCH_COFFEE_STORE, payload: storesByLocation})
    }
  }, [latLong]);

  return (
    <div className={styles.container}>
      <Head>
        <title>Chill with Coffee</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <Banner
        buttonText={findingLocation ? "Loading..." : "Locate your coffee"}
        id="0"
        clickHandler={trackLocation}
      />
      {locationErrorMsg && <p>Something went wrong: {locationErrorMsg}</p>}
      {coffeeStores.length > 0 && (
        <div>
          <h1>Coffee Stores Near you </h1>
          <CoffeeCards Stores={coffeeStores} />
        </div>
      )}
      <div>
        <h1>Coffee Stores: {origin} </h1>
        <CoffeeCards Stores={Stores} />
      </div>
    </div>
  );
}
